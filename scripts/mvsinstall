#!/bin/bash
# mvsinstall - Copy load module into target LINKLIB via IEBCOPY
set -euo pipefail

# --- Load .env (working directory first, then script's repo root) ---
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
if [[ -f "$PWD/.env" ]]; then
  source "$PWD/.env"
elif [[ -f "$ROOT_DIR/.env" ]]; then
  source "$ROOT_DIR/.env"
fi

SOURCE="${MVSINSTALL_SOURCE:?MVSINSTALL_SOURCE not set (check config.mk)}"
TARGET="${MVSINSTALL_TARGET:?MVSINSTALL_TARGET not set (check config.mk)}"
MEMBER="${MVSINSTALL_MEMBER:?MVSINSTALL_MEMBER not set (check config.mk)}"
JOBCLASS="${MVSASM_JOBCLASS:-A}"
MSGCLASS="${MVSASM_MSGCLASS:-H}"

# --- Validate required settings ---
: "${MVSASM_HOST:?MVSASM_HOST not set (check .env)}"
: "${MVSASM_PORT:?MVSASM_PORT not set (check .env)}"
: "${MVSASM_USER:?MVSASM_USER not set (check .env)}"
: "${MVSASM_PASS:?MVSASM_PASS not set (check .env)}"

BASE_URL="http://${MVSASM_HOST}:${MVSASM_PORT}/zosmf/restjobs/jobs"
JOBNAME="INS${MEMBER}"
JOBNAME="${JOBNAME:0:8}"

# --- Generate JCL ---
if [[ "${MVSASM_KEEP_JCL:-0}" == "1" ]]; then
  TEMPFILE="$ROOT_DIR/jcl/$JOBNAME.jcl"
else
  TEMPFILE=$(mktemp)
  trap 'rm -f "$TEMPFILE"' EXIT
fi

cat > "$TEMPFILE" <<ENDJCL
//$JOBNAME JOB CLASS=$JOBCLASS,REGION=0K,MSGCLASS=$MSGCLASS,
//            MSGLEVEL=(1,1),NOTIFY=DUMMY
//*
//DEPLOY   EXEC PGM=IEBCOPY
//SYSPRINT DD SYSOUT=*
//SYSUT1   DD DISP=SHR,DSN=$SOURCE
//SYSUT2   DD DISP=SHR,DSN=$TARGET
//SYSIN    DD *
  COPY INDD=SYSUT1,OUTDD=SYSUT2
  SELECT MEMBER=(($MEMBER,,R))
/*
//*
ENDJCL

# --- Strip CR ---
sed 's/\r$//' "$TEMPFILE" > "${TEMPFILE}.tmp" && mv "${TEMPFILE}.tmp" "$TEMPFILE"

# --- Submit via curl ---
RESULT=$(curl -s -S --connect-timeout 10 --max-time 60 -X PUT \
  -u "${MVSASM_USER}:${MVSASM_PASS}" \
  -H "Content-Type: text/plain" \
  -H "X-IBM-Intrdr-Mode: TEXT" \
  -H "X-IBM-Intrdr-Lrecl: 80" \
  -H "X-IBM-Intrdr-Recfm: F" \
  --data-binary @"$TEMPFILE" \
  "$BASE_URL" 2>&1) || {
  echo "mvsinstall: connection failed" >&2
  echo "$RESULT" >&2
  exit 1
}

JOBID=$(echo "$RESULT" | jq -r '.jobid // empty' 2>/dev/null) || true
RETCODE=$(echo "$RESULT" | jq -r '.retcode // empty' 2>/dev/null) || true

if [[ -z "$JOBID" ]]; then
  echo "mvsinstall: submit failed" >&2
  echo "$RESULT" >&2
  exit 1
fi

echo "mvsinstall: $JOBNAME ($JOBID) submitted"

# --- Poll for job completion ---
# IEBCOPY replaces the LMOD that HTTPD has loaded, causing HTTPD to
# restart. Wait before polling so HTTPD is back up.
sleep 5
while [[ -z "$RETCODE" || "$RETCODE" == "null" ]]; do
  sleep 2
  STATUS=$(curl -s --connect-timeout 10 --max-time 30 -u "${MVSASM_USER}:${MVSASM_PASS}" \
    "$BASE_URL/$JOBNAME/$JOBID" 2>&1)
  RETCODE=$(echo "$STATUS" | jq -r '.retcode // empty' 2>/dev/null) || true
done

# --- Evaluate return code ---
RC_NUM=$(echo "$RETCODE" | grep -oE '[0-9]+' | head -1)
RC_NUM=$((10#${RC_NUM:-9999}))

if [[ "$RC_NUM" -gt 0 ]]; then
  echo "mvsinstall: $JOBNAME ($JOBID) FAILED RC=$RETCODE" >&2
  exit 1
fi

echo "mvsinstall: $JOBNAME ($JOBID) $RETCODE"
exit 0
